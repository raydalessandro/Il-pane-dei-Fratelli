<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Pane dei Fratelli - Panetteria Virtuale</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Georgia', serif;
            background: #2c1810;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(139, 69, 19, 0.9);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            max-width: 350px;
            border: 2px solid #d4af37;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        #dialogue-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 248, 220, 0.98);
            color: #8b4513;
            padding: 25px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            display: none;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border: 3px solid #d4af37;
        }
        
        #dialogue-box h3 {
            margin: 0 0 15px 0;
            color: #8b4513;
            font-size: 1.4em;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 8px;
        }
        
        #dialogue-content {
            margin: 15px 0;
            line-height: 1.7;
            max-height: 250px;
            overflow-y: auto;
            font-size: 1.1em;
        }
        
        .dialogue-option {
            background: linear-gradient(145deg, #fff8dc, #f5e6d3);
            border: 2px solid #d4af37;
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .dialogue-option:hover {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: white;
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }
        
        #custom-question-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #d4af37;
        }
        
        #custom-question-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4af37;
            border-radius: 10px;
            font-size: 16px;
            font-family: Georgia, serif;
            box-sizing: border-box;
            background: rgba(255, 248, 220, 0.9);
        }
        
        #custom-question-submit {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: Georgia, serif;
        }
        
        #custom-question-submit:hover {
            background: linear-gradient(145deg, #b8941f, #9a7a1a);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #custom-question-submit:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: #d4af37;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instruction {
            opacity: 0.9;
            font-size: 14px;
            margin-top: 8px;
            color: #fff8dc;
        }
        
        #interaction-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 69, 19, 0.95);
            color: #fff8dc;
            padding: 15px 25px;
            border-radius: 25px;
            display: none;
            font-size: 16px;
            border: 2px solid #d4af37;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        
        .floating-text {
            position: absolute;
            color: #d4af37;
            font-size: 28px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 2.5s ease-out forwards;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-120px); }
        }

        h2 {
            color: #d4af37;
            margin: 0 0 5px 0;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #subtitle {
            color: #fff8dc;
            font-size: 1.2em;
            margin: 5px 0 15px 0;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="ui-overlay">
        <h2>üçû Il Pane dei Fratelli</h2>
        <p id="subtitle">Panetteria Virtuale</p>
        <p class="instruction">üö∂ WASD per muoverti</p>
        <p class="instruction">üñ±Ô∏è Frecce o mouse per guardarti intorno</p>
        <p class="instruction">üí¨ Premi E per parlare</p>
        <p class="instruction">üï∫ SPAZIO per ballare</p>
        <p class="instruction">‚ùå ESC per chiudere dialoghi</p>
        <p class="instruction" style="margin-top: 15px; font-weight: bold; color: #d4af37;">üí° Fai domande personalizzate quando parli con noi!</p>
    </div>
    
    <div id="dialogue-box">
        <h3 id="dialogue-name">Nome</h3>
        <div id="dialogue-content">Contenuto</div>
        <div id="dialogue-options"></div>
        <div id="custom-question-container">
            <p style="margin: 8px 0; font-size: 14px; opacity: 0.8; text-align: center;">‚îÅ‚îÅ‚îÅ Oppure fai la tua domanda ‚îÅ‚îÅ‚îÅ</p>
            <input type="text" id="custom-question-input" placeholder="Chiedi quello che vuoi! Es: 'Che pane fate oggi?' o 'Avete dolci senza glutine?'" maxlength="200">
            <button id="custom-question-submit">Fai Domanda</button>
        </div>
    </div>
    
    <div id="interaction-prompt">Premi E per parlare</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x8b6914);
        scene.fog = new THREE.Fog(0x8b6914, 10, 50);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 8);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        // Floating text effect
        function createFloatingText(text, worldPos) {
            const screenPos = worldPos.clone();
            screenPos.project(camera);
            
            const x = (screenPos.x * 0.5 + 0.5) * window.innerWidth;
            const y = (-screenPos.y * 0.5 + 0.5) * window.innerHeight;
            
            const div = document.createElement('div');
            div.className = 'floating-text';
            div.textContent = text;
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 2500);
        }
        
        // Warm bakery lighting
        const ambientLight = new THREE.AmbientLight(0xffa500, 0.6);
        scene.add(ambientLight);
        
        const mainLight = new THREE.DirectionalLight(0xffaa44, 0.8);
        mainLight.position.set(10, 15, 10);
        mainLight.castShadow = true;
        mainLight.shadow.camera.near = 0.1;
        mainLight.shadow.camera.far = 50;
        mainLight.shadow.camera.left = -30;
        mainLight.shadow.camera.right = 30;
        mainLight.shadow.camera.top = 30;
        mainLight.shadow.camera.bottom = -30;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        scene.add(mainLight);

        // Warm accent lights
        const accentLight1 = new THREE.PointLight(0xffcc66, 0.5, 20);
        accentLight1.position.set(-10, 5, -10);
        scene.add(accentLight1);

        const accentLight2 = new THREE.PointLight(0xffcc66, 0.5, 20);
        accentLight2.position.set(10, 5, -10);
        scene.add(accentLight2);
        
        // Bakery floor with warm tiles
        const floorGeometry = new THREE.PlaneGeometry(40, 40);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xd2b48c,
            roughness: 0.8,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        
        // Terracotta tile pattern
        const tileGeometry = new THREE.PlaneGeometry(2, 2);
        const tileMaterial1 = new THREE.MeshStandardMaterial({ color: 0xcd853f });
        const tileMaterial2 = new THREE.MeshStandardMaterial({ color: 0xdaa520 });
        
        for (let x = -20; x < 20; x += 2) {
            for (let z = -20; z < 20; z += 2) {
                const tile = new THREE.Mesh(tileGeometry, ((x + z) / 2) % 2 === 0 ? tileMaterial1 : tileMaterial2);
                tile.position.set(x + 1, 0.01, z + 1);
                tile.rotation.x = -Math.PI / 2;
                tile.receiveShadow = true;
                scene.add(tile);
            }
        }
        
        // Warm brick walls
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xd2691e,
            roughness: 0.9
        });
        
        const windowMaterial = new THREE.MeshStandardMaterial({
            color: 0x87ceeb,
            transparent: true,
            opacity: 0.4,
            roughness: 0.1
        });
        
        // Back wall with large bakery window
        const backWall = new THREE.Mesh(
            new THREE.PlaneGeometry(40, 10),
            wallMaterial
        );
        backWall.position.set(0, 5, -20);
        backWall.receiveShadow = true;
        scene.add(backWall);
        
        // Large display window
        const displayWindow = new THREE.Mesh(
            new THREE.PlaneGeometry(12, 4),
            windowMaterial
        );
        displayWindow.position.set(0, 4, -19.9);
        scene.add(displayWindow);
        
        // Side walls
        const leftWall = new THREE.Mesh(
            new THREE.PlaneGeometry(40, 10),
            wallMaterial
        );
        leftWall.position.set(-20, 5, 0);
        leftWall.rotation.y = Math.PI / 2;
        leftWall.receiveShadow = true;
        scene.add(leftWall);
        
        const rightWall = new THREE.Mesh(
            new THREE.PlaneGeometry(40, 10),
            wallMaterial
        );
        rightWall.position.set(20, 5, 0);
        rightWall.rotation.y = -Math.PI / 2;
        rightWall.receiveShadow = true;
        scene.add(rightWall);
        
        // Bakery furniture and equipment
        const woodMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x8b4513,
            roughness: 0.7,
            metalness: 0.1
        });
        
        const metalMaterial = new THREE.MeshStandardMaterial({
            color: 0x696969,
            roughness: 0.4,
            metalness: 0.8
        });

        // Bread display cases
        function createDisplayCase(x, z, width = 4, depth = 1.5) {
            const caseGroup = new THREE.Group();
            
            // Base
            const base = new THREE.Mesh(
                new THREE.BoxGeometry(width, 0.8, depth),
                woodMaterial
            );
            base.position.y = 0.4;
            base.castShadow = true;
            base.receiveShadow = true;
            caseGroup.add(base);
            
            // Glass display
            const glass = new THREE.Mesh(
                new THREE.BoxGeometry(width - 0.2, 0.6, depth - 0.2),
                new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.3,
                    roughness: 0.1
                })
            );
            glass.position.y = 1.1;
            caseGroup.add(glass);
            
            // Display shelves
            for (let i = 0; i < 2; i++) {
                const shelf = new THREE.Mesh(
                    new THREE.BoxGeometry(width - 0.4, 0.05, depth - 0.4),
                    new THREE.MeshStandardMaterial({ color: 0xffffff })
                );
                shelf.position.set(0, 0.9 + i * 0.3, 0);
                caseGroup.add(shelf);
            }
            
            caseGroup.position.set(x, 0, z);
            return caseGroup;
        }
        
        // Add display cases
        const mainDisplay = createDisplayCase(0, -15, 8, 2);
        const sideDisplay1 = createDisplayCase(-10, -8, 4, 1.5);
        const sideDisplay2 = createDisplayCase(10, -8, 4, 1.5);
        scene.add(mainDisplay, sideDisplay1, sideDisplay2);
        
        // Bakery ovens
        function createOven(x, z) {
            const ovenGroup = new THREE.Group();
            
            // Oven body
            const ovenBody = new THREE.Mesh(
                new THREE.BoxGeometry(2, 1.5, 1.2),
                metalMaterial
            );
            ovenBody.position.y = 0.75;
            ovenBody.castShadow = true;
            ovenGroup.add(ovenBody);
            
            // Oven door
            const ovenDoor = new THREE.Mesh(
                new THREE.BoxGeometry(1.6, 1.2, 0.1),
                new THREE.MeshStandardMaterial({ color: 0x2f2f2f })
            );
            ovenDoor.position.set(0, 0.75, 0.65);
            ovenGroup.add(ovenDoor);
            
            // Oven window
            const ovenWindow = new THREE.Mesh(
                new THREE.BoxGeometry(1, 0.6, 0.05),
                new THREE.MeshStandardMaterial({ 
                    color: 0xff4500,
                    emissive: 0x331100,
                    transparent: true,
                    opacity: 0.8
                })
            );
            ovenWindow.position.set(0, 0.75, 0.7);
            ovenGroup.add(ovenWindow);
            
            ovenGroup.position.set(x, 0, z);
            return ovenGroup;
        }
        
        // Add ovens
        const oven1 = createOven(-15, 10);
        const oven2 = createOven(-12, 10);
        scene.add(oven1, oven2);
        
        // Counter/cashier area
        const counter = new THREE.Mesh(
            new THREE.BoxGeometry(6, 1, 1.5),
            woodMaterial
        );
        counter.position.set(0, 0.5, 12);
        counter.castShadow = true;
        counter.receiveShadow = true;
        scene.add(counter);
        
        // Cash register
        const cashRegister = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.5, 0.6),
            metalMaterial
        );
        cashRegister.position.set(0, 1.25, 12);
        cashRegister.castShadow = true;
        scene.add(cashRegister);
        
        // Working tables
        function createWorkTable(x, z) {
            const tableGroup = new THREE.Group();
            
            const tableTop = new THREE.Mesh(
                new THREE.BoxGeometry(3, 0.1, 2),
                new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            tableTop.position.y = 0.9;
            tableTop.castShadow = true;
            tableTop.receiveShadow = true;
            tableGroup.add(tableTop);
            
            // Table legs
            const legPositions = [[-1.4, -0.9], [1.4, -0.9], [-1.4, 0.9], [1.4, 0.9]];
            legPositions.forEach(([lx, lz]) => {
                const leg = new THREE.Mesh(
                    new THREE.BoxGeometry(0.1, 0.9, 0.1),
                    metalMaterial
                );
                leg.position.set(lx, 0.45, lz);
                leg.castShadow = true;
                tableGroup.add(leg);
            });
            
            tableGroup.position.set(x, 0, z);
            return tableGroup;
        }
        
        // Add work tables
        const workTable1 = createWorkTable(-8, 0);
        const workTable2 = createWorkTable(8, 0);
        scene.add(workTable1, workTable2);
        
        // Flour sacks and ingredients
        function createFlourSack(x, z, color = 0xf5f5dc) {
            const sack = new THREE.Mesh(
                new THREE.CylinderGeometry(0.4, 0.5, 0.8, 8),
                new THREE.MeshStandardMaterial({ color: color })
            );
            sack.position.set(x, 0.4, z);
            sack.castShadow = true;
            return sack;
        }
        
        // Add flour sacks
        const flourSack1 = createFlourSack(-18, 15, 0xf5f5dc); // White flour
        const flourSack2 = createFlourSack(-16, 15, 0xdeb887); // Whole wheat
        const flourSack3 = createFlourSack(-14, 15, 0xd2691e); // Rye flour
        scene.add(flourSack1, flourSack2, flourSack3);
        
        // Bread baskets with bread loaves
        function createBreadBasket(x, z) {
            const basketGroup = new THREE.Group();
            
            // Basket
            const basket = new THREE.Mesh(
                new THREE.CylinderGeometry(0.6, 0.5, 0.3, 8),
                new THREE.MeshStandardMaterial({ color: 0x8b4513 })
            );
            basket.position.y = 0.15;
            basketGroup.add(basket);
            
            // Bread loaves
            for (let i = 0; i < 3; i++) {
                const bread = new THREE.Mesh(
                    new THREE.SphereGeometry(0.2, 8, 6),
                    new THREE.MeshStandardMaterial({ 
                        color: 0xdaa520,
                        roughness: 0.8
                    })
                );
                bread.position.set(
                    (Math.random() - 0.5) * 0.8,
                    0.35 + i * 0.1,
                    (Math.random() - 0.5) * 0.8
                );
                bread.scale.set(1, 0.6, 1.2); // Bread loaf shape
                basketGroup.add(bread);
            }
            
            basketGroup.position.set(x, 0, z);
            return basketGroup;
        }
        
        // Add bread baskets
        const breadBasket1 = createBreadBasket(5, -15);
        const breadBasket2 = createBreadBasket(-5, -15);
        scene.add(breadBasket1, breadBasket2);
        
        // Characters - Il Pane dei Fratelli team
        const characters = [];
        
        function createCharacter(name, role, x, z, shirtColor, characterData) {
            const group = new THREE.Group();
            
            // Torso with apron
            const torsoGeometry = new THREE.CylinderGeometry(0.25, 0.3, 0.8, 8);
            const torsoMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const torso = new THREE.Mesh(torsoGeometry, torsoMaterial);
            torso.position.y = 0.6;
            torso.castShadow = true;
            group.add(torso);
            
            // Apron
            const apron = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.6, 0.05),
                new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            apron.position.set(0, 0.6, 0.3);
            group.add(apron);
            
            // Arms
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 6);
            const armMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.3, 0.7, 0);
            leftArm.rotation.z = Math.PI / 8;
            group.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.3, 0.7, 0);
            rightArm.rotation.z = -Math.PI / 8;
            group.add(rightArm);
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 6);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, 0.4, 0);
            group.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, 0.4, 0);
            group.add(rightLeg);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25, 8, 6);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.25;
            head.castShadow = true;
            group.add(head);
            
            // Hair
            const hairGeometry = new THREE.SphereGeometry(0.27, 8, 6);
            const hairMaterial = new THREE.MeshStandardMaterial({ color: characterData.hairColor });
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.y = 1.35;
            hair.scale.y = 0.6;
            group.add(hair);
            
            // Baker's hat for some characters
            if (characterData.hasHat) {
                const hat = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.25, 0.4, 8),
                    new THREE.MeshStandardMaterial({ color: 0xffffff })
                );
                hat.position.y = 1.6;
                group.add(hat);
            }
            
            // Eyes
            const eyeGeometry = new THREE.SphereGeometry(0.03, 4, 4);
            const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.08, 1.25, 0.22);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.08, 1.25, 0.22);
            group.add(rightEye);
            
            // Name label
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 80;
            const context = canvas.getContext('2d');
            context.fillStyle = 'rgba(139, 69, 19, 0.95)';
            context.fillRect(0, 0, 300, 80);
            context.strokeStyle = '#d4af37';
            context.lineWidth = 4;
            context.strokeRect(2, 2, 296, 76);
            context.fillStyle = '#d4af37';
            context.font = 'bold 22px Georgia';
            context.textAlign = 'center';
            context.fillText(name, 150, 32);
            context.font = '18px Georgia';
            context.fillStyle = '#fff8dc';
            context.fillText(role, 150, 56);
            
            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            label.position.y = 1.9;
            label.scale.set(2.2, 0.6, 1);
            group.add(label);
            
            group.position.set(x, 0, z);
            group.userData = { 
                name, 
                role, 
                conversations: [],
                initialPosition: new THREE.Vector3(x, 0, z),
                targetPosition: new THREE.Vector3(x, 0, z),
                moveTimer: 0,
                isDancing: false,
                tripChance: 0.001,
                leftArm: leftArm,
                rightArm: rightArm,
                ...characterData
            };
            
            characters.push(group);
            return group;
        }
        
        // Add bakery team members
        const alessandro = createCharacter('Alessandro', 'Proprietario & Panettiere', -2, 10, 0x8b4513, {
            hairColor: 0x3d3d3d,
            hasHat: true,
            personality: 'appassionato e tradizionale',
            quirk: 'conosce la storia di ogni ricetta che prepara'
        });
        
        const marco = createCharacter('Marco', 'Fratello & Co-Proprietario', 2, 10, 0x228b22, {
            hairColor: 0x4b0082,
            hasHat: true,
            personality: 'innovativo e creativo',
            quirk: 'sperimenta sempre nuove ricette fusion'
        });
        
        const nonna = createCharacter('Nonna Teresa', 'Custode delle Ricette', -8, 5, 0x9370db, {
            hairColor: 0xd3d3d3,
            hasHat: false,
            personality: 'saggia e amorevole',
            quirk: 'misura tutto a occhio ma non sbaglia mai'
        });
        
        const sofia = createCharacter('Sofia', 'Pasticciera', 8, 5, 0xff69b4, {
            hairColor: 0x8b4513,
            hasHat: false,
            personality: 'artistica e precisissima',
            quirk: 'decora ogni dolce come fosse un\'opera d\'arte'
        });
        
        const giuseppe = createCharacter('Giuseppe', 'Aiuto Panettiere', -5, 0, 0x4169e1, {
            hairColor: 0x654321,
            hasHat: true,
            personality: 'instancabile e allegro',
            quirk: 'canta sempre mentre impasta'
        });
        
        const maria = createCharacter('Maria', 'Commessa & Cliente Expert', 5, 0, 0xffa500, {
            hairColor: 0x2e1a1a,
            hasHat: false,
            personality: 'sorridente e disponibile',
            quirk: 'ricorda le preferenze di tutti i clienti'
        });
        
        scene.add(alessandro, marco, nonna, sofia, giuseppe, maria);
        
        // Get references to input elements
        const customQuestionInput = document.getElementById('custom-question-input');
        const customQuestionSubmit = document.getElementById('custom-question-submit');
        
        // Player controls
        const player = {
            position: new THREE.Vector3(0, 1.6, 8),
            velocity: new THREE.Vector3(0, 0, 0),
            speed: 0.1,
            isDancing: false
        };
        
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            if (document.activeElement === customQuestionInput) {
                if (e.key === 'Escape') {
                    dialogueBox.style.display = 'none';
                    currentCharacter = null;
                    if (document.pointerLockElement === renderer.domElement) {
                        document.exitPointerLock();
                    }
                }
                return;
            }
            
            keys[e.key.toLowerCase()] = true;
            keys[e.key] = true;
            
            if (e.key.toLowerCase() === 'e' && nearbyCharacter && dialogueBox.style.display !== 'block') {
                e.preventDefault();
                openDialogue(nearbyCharacter);
            }
            
            if (e.key === ' ' && dialogueBox.style.display !== 'block') {
                e.preventDefault();
                player.isDancing = true;
                createFloatingText('üï∫üíÉ', player.position);
            }
            
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (document.activeElement === customQuestionInput) {
                return;
            }
            
            keys[e.key.toLowerCase()] = false;
            keys[e.key] = false;
            
            if (e.key === ' ' && dialogueBox.style.display !== 'block') {
                player.isDancing = false;
            }
        });
        
        // Character movement AI
        function updateCharacterMovement(character, deltaTime) {
            if (Math.random() < character.userData.tripChance && !character.userData.isDancing) {
                character.rotation.x = Math.PI / 4;
                character.position.y = 0.3;
                createFloatingText('Ops!', character.position);
                
                setTimeout(() => {
                    character.rotation.x = 0;
                    character.position.y = 0;
                }, 1000);
                
                character.userData.tripChance = 0;
                setTimeout(() => {
                    character.userData.tripChance = 0.001;
                }, 5000);
            }
            
            if (character === currentCharacter || character.userData.isDancing) {
                if (character === currentCharacter) {
                    const lookTarget = new THREE.Vector3(player.position.x, character.position.y, player.position.z);
                    character.lookAt(lookTarget);
                    character.rotation.x = 0;
                    character.rotation.z = 0;
                }
                return;
            }
            
            if (Math.random() < 0.001) {
                character.userData.isDancing = true;
                createFloatingText('üéµ', character.position);
                setTimeout(() => {
                    character.userData.isDancing = false;
                }, 3000);
            }
            
            character.userData.moveTimer -= deltaTime;
            
            if (character.userData.moveTimer <= 0) {
                const angle = Math.random() * Math.PI * 2;
                const distance = 2 + Math.random() * 4;
                character.userData.targetPosition = new THREE.Vector3(
                    character.userData.initialPosition.x + Math.cos(angle) * distance,
                    0,
                    character.userData.initialPosition.z + Math.sin(angle) * distance
                );
                
                character.userData.targetPosition.x = Math.max(-18, Math.min(18, character.userData.targetPosition.x));
                character.userData.targetPosition.z = Math.max(-18, Math.min(18, character.userData.targetPosition.z));
                
                character.userData.moveTimer = 4 + Math.random() * 6;
            }
            
            const direction = new THREE.Vector3().subVectors(character.userData.targetPosition, character.position);
            direction.y = 0;
            const distance = direction.length();
            
            if (distance > 0.1) {
                direction.normalize();
                character.position.add(direction.multiplyScalar(0.02));
                
                character.lookAt(character.userData.targetPosition);
                character.rotation.x = 0;
                character.rotation.z = 0;
                
                if (!character.userData.isDancing) {
                    character.position.y = Math.abs(Math.sin(Date.now() * 0.005)) * 0.05;
                }
            }
        }
        
        // Dialogue system for bakery
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueName = document.getElementById('dialogue-name');
        const dialogueContent = document.getElementById('dialogue-content');
        const dialogueOptions = document.getElementById('dialogue-options');
        const interactionPrompt = document.getElementById('interaction-prompt');
        
        let currentCharacter = null;
        let nearbyCharacter = null;
        
        function generateDialogueOptions(character) {
            const allQuestions = [
                // Prodotti e specialit√†
                "Che pane fate oggi?",
                "Quali sono le vostre specialit√†?",
                "Avete dolci senza glutine?",
                "Fate il pane integrale?",
                "Che dolci avete oggi?",
                "Avete prodotti vegani?",
                "Qual √® il vostro pane pi√π venduto?",
                "Fate torte su ordinazione?",
                
                // Storia e tradizione
                "Da quanto tempo esiste la panetteria?",
                "Come avete iniziato?",
                "Chi vi ha insegnato a fare il pane?",
                "Quale ricetta vi piace di pi√π?",
                "Usate ricette di famiglia?",
                "Come scegliete gli ingredienti?",
                
                // Processo e qualit√†
                "Come fate il pane?",
                "Quante ore ci vogliono per fare il pane?",
                "Usate lievito madre?",
                "Da dove viene la farina?",
                "Fate tutto artigianalmente?",
                "Quando sfornate il pane fresco?",
                
                // Servizi e orari
                "A che ora aprite?",
                "Fate consegne a domicilio?",
                "Accettate prenotazioni?",
                "Avete un menu per celiaci?",
                "Fate catering per eventi?",
                "Come posso ordinare una torta?",
                
                // Curiosit√† divertenti
                "Qual √® il vostro segreto?",
                "Avete mai bruciato il pane?",
                "Quale dolce preferiscono i bambini?",
                "Cosa mangiate voi?",
                "Vi piace alzarvi presto?",
                "Cantate mentre lavorate?",
                "Qual √® stata la richiesta pi√π strana?",
                "Come fate a non mangiare tutto?",
                
                // Stagionali e eventi
                "Avete dolci natalizi?",
                "Fate il panettone?",
                "Cosa preparate per Pasqua?",
                "Avete offerte speciali?",
                "Partecipate a sagre?"
            ];
            
            const shuffled = allQuestions.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, 4);
        }
        
        function openDialogue(character) {
            currentCharacter = character;
            dialogueBox.style.display = 'block';
            dialogueName.textContent = `${character.userData.name} - ${character.userData.role}`;
            
            if (document.pointerLockElement === renderer.domElement) {
                document.exitPointerLock();
            }
            
            const greetings = [
                `Ciao! Sono ${character.userData.name}, ${character.userData.role}. Come posso aiutarti?`,
                `Benvenuto nella nostra panetteria! Sono ${character.userData.name}. ${character.userData.quirk}!`,
                `Salve! ${character.userData.name} qui. Cosa posso consigliarti oggi?`,
                `Buongiorno! Sono ${character.userData.name}. Ti va di scoprire i nostri prodotti?`
            ];
            
            if (character.userData.conversations.length === 0) {
                dialogueContent.innerHTML = `<p><strong>${character.userData.name}:</strong> ${greetings[Math.floor(Math.random() * greetings.length)]}</p>`;
            } else {
                const lastConv = character.userData.conversations[character.userData.conversations.length - 1];
                dialogueContent.innerHTML = `<p><strong>Tu:</strong> ${lastConv.user}</p><p><strong>${character.userData.name}:</strong> ${lastConv.response}</p>`;
            }
            
            const options = generateDialogueOptions(character);
            dialogueOptions.innerHTML = '';
            
            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'dialogue-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(option);
                dialogueOptions.appendChild(optionDiv);
            });
            
            document.getElementById('custom-question-input').value = '';
            
            setTimeout(() => {
                document.getElementById('custom-question-input').focus();
            }, 100);
        }
        
        async function selectOption(option) {
            if (!currentCharacter) return;
            
            dialogueContent.innerHTML += `<p><strong>Tu:</strong> ${option}</p>`;
            dialogueContent.innerHTML += `<p><strong>${currentCharacter.userData.name}:</strong> <span class="loading"></span></p>`;
            
            dialogueContent.scrollTop = dialogueContent.scrollHeight;
            
            const customQuestionInput = document.getElementById('custom-question-input');
            const customQuestionSubmit = document.getElementById('custom-question-submit');
            
            dialogueOptions.style.pointerEvents = 'none';
            dialogueOptions.style.opacity = '0.5';
            customQuestionInput.disabled = true;
            customQuestionSubmit.disabled = true;
            
            let responseText = "";
            
            try {
                const prompt = `Sei ${currentCharacter.userData.name}, ${currentCharacter.userData.role} nella panetteria "Il Pane dei Fratelli".
Personalit√†: ${currentCharacter.userData.personality}, ${currentCharacter.userData.quirk}
Domanda del cliente: "${option}"

Contesto importante: 
- Lavori nella panetteria "Il Pane dei Fratelli" a Milano
- Fate pane artigianale, dolci, torte su ordinazione
- Usate ingredienti di qualit√† e ricette tradizionali
- Siete una famiglia di panettieri
- Aprite presto la mattina per avere pane fresco
- Fate anche prodotti senza glutine e vegani su richiesta
- Siete nel quartiere da generazioni

${option.length > 30 ? 'Questa √® una domanda personalizzata del cliente, quindi sii creativo e resta nel personaggio!' : ''}

Rispondi come questo personaggio con calore, passione per il pane e orgoglio per la tradizione familiare in 60-100 parole. Usa un tono amichevole e professionale, tipico di una panetteria italiana.

IMPORTANTE: Output SOLO JSON valido:
{"response": "la tua risposta qui"}`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                
                const data = await response.json();
                let responseData = data.content[0].text;
                
                // Clean up any markdown formatting
                responseData = responseData.replace(/```json\s*/g, "").replace(/```\s*/g, "").trim();
                
                try {
                    const parsedData = JSON.parse(responseData);
                    responseText = parsedData.response;
                } catch (parseError) {
                    console.warn('JSON parsing failed, using fallback responses');
                    responseText = generateFallbackResponse(currentCharacter, option);
                }
                
            } catch (error) {
                console.error('API Error:', error);
                responseText = generateFallbackResponse(currentCharacter, option);
            }
            
            currentCharacter.userData.conversations.push({
                user: option,
                response: responseText
            });
            
            dialogueContent.innerHTML = dialogueContent.innerHTML.replace(
                '<span class="loading"></span>',
                responseText
            );
            
            dialogueContent.scrollTop = dialogueContent.scrollHeight;
            
            if (Math.random() < 0.2) {
                createFloatingText('üí°', currentCharacter.position);
            }
            
            const newOptions = generateDialogueOptions(currentCharacter);
            dialogueOptions.innerHTML = '';
            
            newOptions.forEach(opt => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'dialogue-option';
                optionDiv.textContent = opt;
                optionDiv.onclick = () => selectOption(opt);
                dialogueOptions.appendChild(optionDiv);
            });
            
            dialogueOptions.style.pointerEvents = 'auto';
            dialogueOptions.style.opacity = '1';
            customQuestionInput.disabled = false;
            customQuestionSubmit.disabled = false;
            customQuestionInput.focus();
        }
        
        // Fallback response generator for bakery
        function generateFallbackResponse(character, question) {
            const responses = {
                'Alessandro': {
                    'prodotti': [
                        "Oggi abbiamo sfornato pane pugliese, integrale e ai cereali. Il nostro cavallo di battaglia √® sempre il pane di Altamura! Lo facciamo con la ricetta di mio nonno.",
                        "Le nostre specialit√†? Focaccia barese, taralli e il pane casereccio che facciamo da tre generazioni. Ogni pagnotta ha la sua storia!"
                    ],
                    'tradizione': [
                        "Ho imparato questo mestiere da mio padre, che l'aveva imparato dal suo. Ogni ricetta racconta la storia della nostra famiglia e del nostro territorio.",
                        "Questa panetteria esiste dal 1952, quando mio nonno apr√¨ qui. Da allora non abbiamo mai smesso di fare il pane con le stesse ricette tradizionali."
                    ],
                    'processo': [
                        "Il nostro segreto? Tempo e passione. Il lievito madre ha 70 anni, lo curiamo come fosse un membro della famiglia. E ci alziamo alle 4 del mattino!",
                        "Facciamo tutto a mano, dalla scelta della farina all'impasto. Il pane ha bisogno di tempo per sviluppare i sapori, non si pu√≤ avere fretta."
                    ],
                    'default': [
                        "Sai, ogni giorno in panetteria √® diverso, ma l'amore per questo mestiere rimane sempre lo stesso. Cosa ti posso consigliare?",
                        "Dopo tanti anni dietro a questo bancone, ho capito che il pane buono si fa con il cuore, non solo con le mani!"
                    ]
                },
                'Marco': {
                    'prodotti': [
                        "Oltre ai classici, stiamo sperimentando nuovi gusti: pane alla curcuma, ai semi di chia, e dolci fusion. La tradizione √® importante, ma anche l'innovazione!",
                        "Abbiamo una linea completamente vegana e senza glutine. Non vuol dire rinunciare al gusto, anzi! Provare per credere."
                    ],
                    'innovazione': [
                        "Mi piace mescolare la tradizione pugliese con sapori dal mondo. L'altro giorno ho fatto dei cornetti con crema al pistacchio e cardamomo!",
                        "Sperimento sempre nuove ricette, ma sempre rispettando la base tradizionale. √à come suonare jazz su una melodia classica."
                    ],
                    'default': [
                        "L'innovazione √® nel mio DNA, ma sempre con rispetto per quello che ci hanno insegnato i nostri nonni. Vuoi assaggiare qualcosa di nuovo?",
                        "Ogni giorno cerco di creare qualcosa che sorprenda i nostri clienti, mantenendo sempre alta la qualit√†. Cosa ne dici di provare una novit√†?"
                    ]
                },
                'Nonna Teresa': {
                    'ricette': [
                        "Le ricette? Le ho tutte qui, nella memoria! 60 anni di esperienza non si dimenticano. Un pizzico di questo, un pugno di quello... e tanto amore.",
                        "I segreti della nonna? Non esistono segreti, solo esperienza e dedizione. Ogni impasto mi parla, so quando √® pronto solo toccandolo."
                    ],
                    'tradizione': [
                        "Ai miei tempi si faceva il pane una volta a settimana, per tutta la famiglia. Era un rito, un momento di condivisione. Quello spirito lo manteniamo ancora.",
                        "Ho insegnato tutto quello che so ad Alessandro e Marco. La tradizione si tramanda cos√¨, di mano in mano, di cuore in cuore."
                    ],
                    'default': [
                        "Bambino mio, in questa panetteria ogni prodotto √® fatto con l'amore di una nonna. Dimmi, cosa ti preparo?",
                        "Dopo tutti questi anni, vedere la gioia nei vostri occhi quando assaggiate i nostri dolci... √® questa la mia ricompensa pi√π grande!"
                    ]
                },
                'Sofia': {
                    'dolci': [
                        "Ogni dolce √® un piccolo capolavoro! Uso solo ingredienti di prima qualit√† e decoro tutto a mano. Le torte su ordinazione sono la mia passione.",
                        "Dai cannoli siciliani ai maritozzi romani, fino ai dolci moderni. Ogni creazione deve essere bella da vedere e deliziosa da mangiare."
                    ],
                    'arte': [
                        "La pasticceria √® arte commestibile! Ogni decorazione racconta una storia, ogni colore ha un significato. Mi ispiro alla natura e alle emozioni.",
                        "Lavoro molto con la pasta di zucchero e il cioccolato plastico. Riesco a creare veri e propri quadri commestibili!"
                    ],
                    'default': [
                        "La dolcezza non √® solo nel sapore, ma anche nella bellezza! Cosa posso creare per te oggi?",
                        "Ogni dolce che faccio √® unico, proprio come ogni persona che entra qui. Dimmi i tuoi gusti e creer√≤ qualcosa di speciale!"
                    ]
                },
                'Giuseppe': {
                    'lavoro': [
                        "Amo questo lavoro! Cantare mentre impasto mi aiuta a mantenere il ritmo giusto. Il pane sente la musica e diventa pi√π soffice!",
                        "Sono qui dalle 4 del mattino, ma vedere i clienti felici del pane appena sfornato... vale ogni ora di sonno persa!"
                    ],
                    'allegria': [
                        "La giornata inizia sempre con una canzone! Mia nonna diceva che il pane fatto con allegria ha un sapore speciale, e aveva ragione.",
                        "Qui si lavora sempre con il sorriso. L'ambiente familiare si sente nei prodotti, ne sono sicuro!"
                    ],
                    'default': [
                        "Buongiorno! Oggi ho preparato tutto cantando, quindi il pane √® particolarmente buono! *sorride* Cosa ti servo?",
                        "L'energia positiva √® il nostro ingrediente segreto! Dimmi, cosa ti fa venire il buonumore al mattino?"
                    ]
                },
                'Maria': {
                    'clienti': [
                        "Ricordo le preferenze di tutti i nostri clienti! La signora Anna prende sempre due pagnotte integrali, il signor Giuseppe ama i cornetti alla crema...",
                        "Il servizio clienti √® fondamentale. Non vendiamo solo pane, creiamo relazioni. Molti clienti sono diventati amici di famiglia."
                    ],
                    'consigli': [
                        "Per i bambini consiglio sempre i biscotti a forma di animali, per le cene romantiche il pane alle olive... ogni occasione ha il suo prodotto perfetto!",
                        "Conosco tutti i nostri prodotti a memoria e so sempre cosa consigliare. Dimmi l'occasione e trover√≤ il dolce perfetto!"
                    ],
                    'default': [
                        "Benvenuto! Sono qui per aiutarti a trovare esattamente quello che cerchi. Cosa posso consigliarti oggi?",
                        "La soddisfazione del cliente √® la mia priorit√†! Non esitare a chiedermi qualsiasi cosa sui nostri prodotti."
                    ]
                }
            };
            
            let responseKey = 'default';
            const questionLower = question.toLowerCase();
            
            if (questionLower.includes('pane') || questionLower.includes('dolci') || questionLower.includes('prodott') || questionLower.includes('special')) responseKey = 'prodotti';
            else if (questionLower.includes('storia') || questionLower.includes('famiglia') || questionLower.includes('ricett') || questionLower.includes('tradiz')) responseKey = 'tradizione';
            else if (questionLower.includes('come') || questionLower.includes('fate') || questionLower.includes('process') || questionLower.includes('lievit')) responseKey = 'processo';
            else if (questionLower.includes('dolc') || questionLower.includes('tort') || questionLower.includes('decoraz')) responseKey = 'dolci';
            else if (questionLower.includes('innova') || questionLower.includes('nuov') || questionLower.includes('fusion')) responseKey = 'innovazione';
            else if (questionLower.includes('client') || questionLower.includes('consiglia')) responseKey = 'clienti';
            else if (questionLower.includes('cant') || questionLower.includes('allegr') || questionLower.includes('music')) responseKey = 'allegria';
            else if (questionLower.includes('arte') || questionLower.includes('bell') || questionLower.includes('color')) responseKey = 'arte';
            else if (questionLower.includes('ricett') || questionLower.includes('nonna') || questionLower.includes('segret')) responseKey = 'ricette';
            else if (questionLower.includes('lavor') || questionLower.includes('giorn') || questionLower.includes('alzat')) responseKey = 'lavoro';
            else if (questionLower.includes('consig') || questionLower.includes('scegli') || questionLower.includes('occas')) responseKey = 'consigli';
            
            const characterResponses = responses[character.userData.name] || {};
            const responseArray = characterResponses[responseKey] || characterResponses['default'] || [
                "Grazie per la tua domanda! Siamo sempre felici di parlare della nostra panetteria e dei nostri prodotti.",
                "√à bello vedere l'interesse per il nostro lavoro! Ogni giorno mettiamo passione in quello che facciamo.",
                "La nostra √® una storia di famiglia e tradizione. Ogni prodotto racconta un pezzo della nostra storia.",
                "Siamo orgogliosi di quello che facciamo e felici di condividerlo con i nostri clienti!"
            ];
            
            return responseArray[Math.floor(Math.random() * responseArray.length)];
        }
        
        // Close dialogue with Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                dialogueBox.style.display = 'none';
                currentCharacter = null;
                if (document.pointerLockElement === renderer.domElement) {
                    document.exitPointerLock();
                }
            }
        });
        
        // Custom question handlers
        customQuestionSubmit.addEventListener('click', () => {
            const customQuestion = customQuestionInput.value.trim();
            if (customQuestion && currentCharacter) {
                selectOption(customQuestion);
                customQuestionInput.value = '';
            }
        });
        
        customQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const customQuestion = customQuestionInput.value.trim();
                if (customQuestion && currentCharacter) {
                    selectOption(customQuestion);
                    customQuestionInput.value = '';
                }
            }
        });
        
        // Animation loop
        let lastTime = 0;
        
        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // Update player movement
            player.velocity.set(0, 0, 0);
            
            if (!player.isDancing && dialogueBox.style.display !== 'block') {
                if (keys['w']) player.velocity.z = player.speed;
                if (keys['s']) player.velocity.z = -player.speed;
                if (keys['a']) player.velocity.x = -player.speed;
                if (keys['d']) player.velocity.x = player.speed;
            }
            
            // Arrow key camera controls
            const lookSpeed = 0.05;
            if (dialogueBox.style.display !== 'block') {
                if (keys['ArrowLeft']) {
                    mouseX += lookSpeed;
                }
                if (keys['ArrowRight']) {
                    mouseX -= lookSpeed;
                }
            }
            
            // Update camera rotation
            if (!player.isDancing && dialogueBox.style.display !== 'block') {
                camera.rotation.y = mouseX;
                camera.rotation.x = 0;
            }
            
            // Apply movement in camera direction
            const forward = new THREE.Vector3(0, 0, -1);
            forward.applyQuaternion(camera.quaternion);
            forward.y = 0;
            forward.normalize();
            
            const right = new THREE.Vector3(1, 0, 0);
            right.applyQuaternion(camera.quaternion);
            right.y = 0;
            right.normalize();
            
            player.position.add(forward.multiplyScalar(player.velocity.z));
            player.position.add(right.multiplyScalar(player.velocity.x));
            
            // Keep player in bounds
            player.position.x = Math.max(-18, Math.min(18, player.position.x));
            player.position.z = Math.max(-18, Math.min(18, player.position.z));
            
            // Dancing animation for player
            if (player.isDancing && dialogueBox.style.display !== 'block') {
                camera.position.y = player.position.y + Math.sin(Date.now() * 0.01) * 0.2;
                camera.rotation.z = Math.sin(Date.now() * 0.01) * 0.1;
                camera.rotation.y = mouseX;
                camera.rotation.x = 0;
            } else {
                camera.position.copy(player.position);
                camera.rotation.z = 0;
                if (dialogueBox.style.display !== 'block') {
                    camera.rotation.y = mouseX;
                    camera.rotation.x = 0;
                }
            }
            
            // Update character movement
            characters.forEach(character => {
                updateCharacterMovement(character, deltaTime);
                
                // Dancing animation
                if (character.userData.isDancing) {
                    character.rotation.y += 0.1;
                    character.position.y = Math.abs(Math.sin(Date.now() * 0.01)) * 0.3;
                    
                    character.userData.leftArm.rotation.z = Math.sin(Date.now() * 0.01) * 0.5 + Math.PI / 8;
                    character.userData.rightArm.rotation.z = -Math.sin(Date.now() * 0.01) * 0.5 - Math.PI / 8;
                }
            });
            
            // Check for nearby characters
            nearbyCharacter = null;
            let minDistance = Infinity;
            
            characters.forEach(character => {
                const distance = player.position.distanceTo(character.position);
                if (distance < 3 && distance < minDistance) {
                    minDistance = distance;
                    nearbyCharacter = character;
                }
            });
            
            // Show/hide interaction prompt
            if (nearbyCharacter && !currentCharacter) {
                interactionPrompt.style.display = 'block';
                interactionPrompt.textContent = `Premi E per parlare con ${nearbyCharacter.userData.name}`;
            } else {
                interactionPrompt.style.display = 'none';
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Mouse look (horizontal only)
        let mouseX = 0;
        let mouseY = 0;
        
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement && dialogueBox.style.display !== 'block') {
                mouseX += e.movementX * 0.002;
            }
        });
        
        renderer.domElement.addEventListener('click', () => {
            if (!dialogueBox.style.display || dialogueBox.style.display === 'none') {
                renderer.domElement.requestPointerLock();
            }
        });
        
        // Add some ambient bakery sounds and visual effects
        function addBakeryAmbiance() {
            // Create steam effects from ovens
            const steamGeometry = new THREE.SphereGeometry(0.1, 8, 6);
            const steamMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xffffff,
                transparent: true,
                opacity: 0.3
            });
            
            setInterval(() => {
                if (Math.random() < 0.3) {
                    const steam = new THREE.Mesh(steamGeometry, steamMaterial);
                    steam.position.set(-13.5 + Math.random() * 2, 1.5, 10);
                    scene.add(steam);
                    
                    // Animate steam rising
                    const steamAnimation = () => {
                        steam.position.y += 0.02;
                        steam.material.opacity -= 0.01;
                        steam.scale.multiplyScalar(1.02);
                        
                        if (steam.material.opacity <= 0) {
                            scene.remove(steam);
                        } else {
                            requestAnimationFrame(steamAnimation);
                        }
                    };
                    steamAnimation();
                }
            }, 2000);
        }
        
        // Add warm lighting animations
        function animateLighting() {
            setInterval(() => {
                // Subtle lighting variations to simulate oven heat
                const variation = Math.sin(Date.now() * 0.001) * 0.1;
                accentLight1.intensity = 0.5 + variation;
                accentLight2.intensity = 0.5 + variation;
            }, 50);
        }
        
        // Add bread aroma particles (visual effect)
        function createAromaEffect() {
            const aromaGeometry = new THREE.SphereGeometry(0.05, 6, 4);
            const aromaMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xffd700,
                transparent: true,
                opacity: 0.2
            });
            
            setInterval(() => {
                if (Math.random() < 0.1) {
                    const aroma = new THREE.Mesh(aromaGeometry, aromaMaterial);
                    aroma.position.set(
                        -5 + Math.random() * 10,
                        0.5,
                        -15 + Math.random() * 5
                    );
                    scene.add(aroma);
                    
                    // Animate aroma floating
                    const aromaAnimation = () => {
                        aroma.position.y += 0.01;
                        aroma.position.x += (Math.random() - 0.5) * 0.02;
                        aroma.position.z += (Math.random() - 0.5) * 0.02;
                        aroma.material.opacity -= 0.002;
                        
                        if (aroma.material.opacity <= 0 || aroma.position.y > 5) {
                            scene.remove(aroma);
                        } else {
                            requestAnimationFrame(aromaAnimation);
                        }
                    };
                    aromaAnimation();
                }
            }, 3000);
        }
        
        // Initialize bakery ambiance
        addBakeryAmbiance();
        animateLighting();
        createAromaEffect();
        
        // Add some seasonal decorations
        function addSeasonalDecorations() {
            // Italian flag
            const flagPole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.02, 0.02, 3, 8),
                new THREE.MeshStandardMaterial({ color: 0x8b4513 })
            );
            flagPole.position.set(18, 1.5, -15);
            scene.add(flagPole);
            
            // Flag stripes
            const greenStripe = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.5, 0.01),
                new THREE.MeshStandardMaterial({ color: 0x009246 })
            );
            greenStripe.position.set(17, 2.8, -15);
            scene.add(greenStripe);
            
            const whiteStripe = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.5, 0.01),
                new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            whiteStripe.position.set(17, 2.3, -15);
            scene.add(whiteStripe);
            
            const redStripe = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.5, 0.01),
                new THREE.MeshStandardMaterial({ color: 0xce2b37 })
            );
            redStripe.position.set(17, 1.8, -15);
            scene.add(redStripe);
            
            // Add some Italian herbs in pots
            const herbPot = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.15, 0.3, 8),
                new THREE.MeshStandardMaterial({ color: 0x8b4513 })
            );
            herbPot.position.set(15, 0.15, 12);
            scene.add(herbPot);
            
            const herbs = new THREE.Mesh(
                new THREE.SphereGeometry(0.25, 6, 5),
                new THREE.MeshStandardMaterial({ color: 0x228b22 })
            );
            herbs.position.set(15, 0.45, 12);
            herbs.scale.set(1, 0.6, 1);
            scene.add(herbs);
            
            // Add more herb pots
            const herbPot2 = herbPot.clone();
            herbPot2.position.set(13, 0.15, 12);
            scene.add(herbPot2);
            
            const herbs2 = herbs.clone();
            herbs2.position.set(13, 0.45, 12);
            scene.add(herbs2);
        }
        
        addSeasonalDecorations();
        
        // Add a welcome sign
        function createWelcomeSign() {
            const signCanvas = document.createElement('canvas');
            signCanvas.width = 512;
            signCanvas.height = 256;
            const ctx = signCanvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#8b4513';
            ctx.fillRect(0, 0, 512, 256);
            
            // Border
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 8;
            ctx.strokeRect(4, 4, 504, 248);
            
            // Text
            ctx.fillStyle = '#d4af37';
            ctx.font = 'bold 36px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText('Benvenuti', 256, 70);
            
            ctx.fillStyle = '#fff8dc';
            ctx.font = 'bold 42px Georgia';
            ctx.fillText('Il Pane dei Fratelli', 256, 130);
            
            ctx.font = '24px Georgia';
            ctx.fillText('Panetteria Artigianale dal 1952', 256, 170);
            
            ctx.font = '20px Georgia';
            ctx.fillText('Pane Fresco ‚Ä¢ Dolci ‚Ä¢ Tradizione', 256, 210);
            
            const signTexture = new THREE.CanvasTexture(signCanvas);
            const signMaterial = new THREE.MeshStandardMaterial({ map: signTexture });
            
            const sign = new THREE.Mesh(
                new THREE.BoxGeometry(4, 2, 0.1),
                signMaterial
            );
            sign.position.set(-10, 3, 19.9);
            sign.castShadow = true;
            scene.add(sign);
            
            // Sign post
            const post = new THREE.Mesh(
                new THREE.CylinderGeometry(0.05, 0.05, 3, 8),
                new THREE.MeshStandardMaterial({ color: 0x8b4513 })
            );
            post.position.set(-10, 1.5, 19.5);
            scene.add(post);
        }
        
        createWelcomeSign();
        
        // Start animation
        animate(0);
    </script>
</body>
</html>
